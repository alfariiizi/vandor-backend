version: "3"

tasks:
  build:
    desc: Build the project
    cmds:
      - echo "Building..."
      - goimports -w .
      - go build -o bin/main cmd/app/main.go

  build:seed:
    desc: Build the seed data generator
    cmds:
      - echo "Building seed data generator..."
      - go build -o bin/seed cmd/seed/main.go

  build:migration:
    desc: Build the migration tool
    cmds:
      - echo "Building migration tool..."
      - go build -o bin/atlas cmd/atlas/main.go

  run:dev:
    desc: Run the application in development mode
    cmds:
      - echo "Running in development mode..."
      - echo "Generating repositories..."
      - go run ./cmd/entgo/main.go
      - goimports -w ./internal/infrastructure/db/rest/.
      - echo "Starting the application..."
      - ./scripts/watch.sh all

  run:seed:
    desc: Generate seed data
    cmds:
      - echo "Running seeder..."
      - go run ./cmd/seed/main.go {{.name}}

  migrate:status:
    desc: Check the status of database migrations
    cmds:
      - echo "Checking migration status..."
      - go run ./cmd/atlas/main.go status

  migrate:diff:
    desc: Generate a migration diff
    cmds:
      - |
        name_sanitized={{ .name | lower | replace " " "_" }}
        echo "Generating migration diff for ${name_sanitized}..."
        go run ./cmd/atlas/main.go diff ${name_sanitized}
    requires:
      vars: [name]

  migrate:up:
    desc: Apply database migrations
    cmds:
      - echo "Applying migrations..."
      - go run ./cmd/atlas/main.go apply

  create:schema:
    desc: Create a new schema
    cmds:
      - echo "Creating new schema..."
      - ./scripts/ent-tools.sh new {{.name}}
    requires:
      vars: [name]

  create:domain:
    desc: Create a new domain
    cmds:
      - echo "Creating new domain..."
      - go run ./cmd/domain/cmd-new-domain/main.go {{.name}}
      - go run ./cmd/domain/cmd-regenerate-domain/main.go
    requires:
      vars: [name]

  create:usecase:
    desc: Create a new usecase
    cmds:
      - echo "Creating new usecase..."
      - go run ./cmd/usecase/cmd-new-usecase/main.go {{.name}}
    requires:
      vars: [name]

  create:service:
    desc: Create a new service
    cmds:
      - echo "Creating new service..."
      - go run ./cmd/service/cmd-new-service/main.go {{.group}} {{.name}}
    requires:
      vars: [group, name]

  create:job:
    desc: Create a new job
    cmds:
      - echo "Creating new job..."
      - go run ./cmd/job/cmd-new-job/main.go {{.name}}
      - go run ./cmd/job/cmd-regenerate-job/main.go
    requires:
      vars: [name]

  create:scheduler:
    desc: Create a new scheduler
    cmds:
      - echo "Creating new scheduler..."
      - go run ./cmd/scheduler/cmd-new-scheduler/main.go {{.name}}
      - go run ./cmd/scheduler/cmd-regenerate-scheduler/main.go
    requires:
      vars: [name]

  create:enum:
    desc: Create a new enum
    cmds:
      - echo "Creating new enum..."
      - go run ./cmd/enum/cmd/main.go add {{.name | lower}}
    requires:
      vars: [name]

  create:seed:
    desc: Create a new seed
    cmds:
      - echo "Creating new seed..."
      - go run ./cmd/seed/cmd-new-seed/main.go {{.name}}
      - go run ./cmd/seed/cmd-generate/main.go
    requires:
      vars: [name]

  create:http-handler:
    desc: Create a new HTTP handler
    cmds:
      - echo "Creating new HTTP handler..."
      - go run ./cmd/http/cmd-new-handler/main.go {{.group}} {{.name}}
        {{.method}}
    requires:
      vars: [group, name, method]

  create:http-handler:crud:
    desc: Generate CRUD for HTTP handler code
    cmds:
      - echo "Regenerate CRUD HTTP handlers..."
      - go run ./cmd/http/crud/main.go {{.model | title}}
      - go run ./cmd/http/cmd-regenerate-handler/main.go
    requires:
      vars: [model]

  create:service:http-handler:
    desc: Create a new HTTP handler for a service
    cmds:
      - echo "Creating new Service and HTTP handler..."
      - go run ./cmd/service/cmd-new-service/main.go {{.group}} {{.name}}
      - go run ./cmd/http/cmd-new-handler/main.go {{.group}} {{.name}}
        {{.method}}
    requires:
      vars: [group, name, method]

  gen:all:
    desc: Generate all code
    cmds:
      - echo "Regenerating all code..."
      - go run ./cmd/domain/cmd-regenerate-domain/main.go
      - go run ./cmd/usecase/cmd-regenerate-usecase/main.go
      - go run ./cmd/service/cmd-regenerate-service/main.go
      - go run ./cmd/http/cmd-regenerate-handler/main.go
      - go run ./cmd/job/cmd-regenerate-job/main.go
      - go run ./cmd/scheduler/cmd-regenerate-scheduler/main.go
      - go run ./cmd/seed/cmd-generate/main.go
      - go run ./cmd/entgo/main.go
      - goimports -w .
    silent: false

  gen:core:
    desc: Generate core code
    cmds:
      - echo "Regenerate core code..."
      - go run ./cmd/usecase/cmd-regenerate-usecase/main.go
      - go run ./cmd/service/cmd-regenerate-service/main.go
      - go run ./cmd/domain/cmd-regenerate-domain/main.go

  gen:domain:
    desc: Generate domain code
    cmds:
      - echo "Regenerate domain code..."
      - go run ./cmd/domain/cmd-regenerate-domain/main.go

  gen:usecase:
    desc: Generate usecase code
    cmds:
      - echo "Regenerate usecases..."
      - go run ./cmd/usecase/cmd-regenerate-usecase/main.go

  gen:service:
    desc: Generate service code
    cmds:
      - echo "Regenerate service..."
      - go run ./cmd/service/cmd-regenerate-service/main.go

  gen:job:
    desc: Generate job code
    cmds:
      - echo "Regenerate jobs..."
      - go run ./cmd/job/cmd-regenerate-job/main.go

  gen:scheduler:
    desc: Generate scheduler code
    cmds:
      - echo "Regenerate schedulers..."
      - go run ./cmd/scheduler/cmd-regenerate-scheduler/main.go

  gen:enum:
    desc: Generate enum code
    cmds:
      - echo "Regenerate enums..."
      - go run ./cmd/enum/cmd/main.go generate

  gen:seed:
    desc: Generate seed code
    cmds:
      - echo "Regenerate seeds..."
      - go run ./cmd/seed/cmd-generate/main.go

  gen:http-handler:
    desc: Generate HTTP handler code
    cmds:
      - echo "Regenerate HTTP handlers..."
      - go run ./cmd/http/cmd-regenerate-handler/main.go

  gen:db-model:
    desc: Generate DB Model code
    cmds:
      - echo "Generating DB Model..."
      - go run ./cmd/entgo/main.go
      - goimports -w ./internal/infrastructure/db/rest/.
    silent: false

  test:
    desc: Run tests
    cmds:
      - echo "Running tests..."
      - go test ./...

  clean:
    desc: Clean up build artifacts
    cmds:
      - echo "Cleaning up..."
      - rm -f myapp

  all:
    desc: Build, test, and clean
    deps: [build, test, clean]
